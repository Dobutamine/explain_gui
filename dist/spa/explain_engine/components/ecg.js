class ECG{constructor(t){this._model={},this.ecg_signal=0,this.measured_heartrate=0,this._prev_p_signal=0,this._prev_t_signal=0,this._prev_qrs_signal=0,this._sa_node_period=0,this._sa_node_counter=0,this._vent_escape_period=0,this._vent_escape_counter=0,this._vent_escape_running=!1,this._pq_time_counter=0,this._pq_running=!1,this._qrs_time_counter=0,this._qrs_running=!1,this._qt_time_counter=0,this._qt_running=!1,this._ventricle_is_refractory=!1,this._measured_heartrate_time_counter=0,this._measured_heartrate_qrs_counter=0,this._model=t,this._update_timer=0,this.ecg_update_interval=.015,this.q_interval=0,this.q_interval_counter=0,this.r_interval=0,this.r_interval_counter=0,this.s_interval=0,this.s_interval_counter=0,this.qrs_vent_escape_time=.35,this._qrs_vent_escape_time_counter=0,this._qrs_vent_escape_running=!1,this.amp_q_vent=0,this.width_q_vent=10,this.skew_q_vent=1,this.amp_r_vent=10,this.width_r_vent=15,this.skew_r_vent=1.1,this.amp_s_vent=-3.5,this.width_s_vent=10,this.skew_s_vent=5,this.block_qrs=!1,this.block_counter=3,this.block_after_beats=3,this.pq_addition=0,this.qt_addition=0,this.qt_multiplier=1.5}qtc(){return this.heart_rate>0?(this.qt_time+this.qt_addition)*Math.sqrt(60/this.heart_rate):(this.qt_time+this.qt_addition)*Math.sqrt(6)}modelStep(){this.is_enabled&&this.modelCycle()}modelCycle(){this._update_timer>=this.ecg_update_interval&&(this._update_timer=0),this._update_timer+=this._model.modeling_stepsize,this.updateECG(this._model.modeling_stepsize)}setRhythmProperties(){switch(this.rhythm_type){case 0:this.block_counter=0,this.block_qrs=!1,this.pq_addition=0,this.qt_addition=0,this.svt_multiplier=1;break;case 1:this.pq_addition=.5*this.pq_time,this.block_counter=0,this.block_qrs=!1,this.qt_addition=0,this.svt_multiplier=1;break;case 2:this.block_counter<this.block_after_beats?this.pq_addition=.4*this.pq_time*this.block_counter:(this.block_qrs=!0,this.pq_addition=0,this.block_counter=0,this.qt_addition=0,this.svt_multiplier=1);break;case 3:this.block_counter>=this.block_after_beats&&(this.block_qrs=!0,this.pq_addition=0,this.block_counter=0,this.qt_addition=0,this.svt_multiplier=1);break;case 4:this.block_qrs=!0,this.pq_addition=0,this.block_counter=0,this.qt_addition=0,this.svt_multiplier=1;break;case 5:this.qt_addition=this.qt_multiplier*this.qt_time;break}}updateECG(t){this.cqt_time=this.qtc()-this.qrs_time,this.heart_rate>0?this._sa_node_period=60/this.heart_rate:this._sa_node_period=60,this.venticular_escape_rate>0?this._vent_escape_period=60/this.venticular_escape_rate:this._vent_escape_period=6e5,this.setRhythmProperties(),this._sa_node_counter>this._sa_node_period&&(this._sa_node_counter=0,this._pq_running=!0,this.ncc_atrial=0),this._vent_escape_counter>this._vent_escape_period&&(this._vent_escape_counter=0,!1===this._ventricle_is_refractory&&(this.q_interval_vent=0*this.qrs_vent_escape_time,this.r_interval_vent=.56667*this.qrs_vent_escape_time,this.s_interval_vent=.43333*this.qrs_vent_escape_time,this._qrs_vent_escape_running=!0,this.ncc_ventricular=0,this._measured_heartrate_qrs_counter+=1)),this._pq_time_counter>this.pq_time+this.pq_addition&&(this._pq_time_counter=0,this._pq_running=!1,!1===this._ventricle_is_refractory&&!1===this._qrs_vent_escape_running&&!1===this.block_qrs&&(this.q_interval=this.qrs_time/3,this.r_interval=this.qrs_time/3,this.s_interval=this.qrs_time/3,this._qrs_running=!0,this.ncc_ventricular=0,this._measured_heartrate_qrs_counter+=1,this._vent_escape_counter=0,this.block_counter+=1),!0===this.block_qrs&&(this.block_qrs=!1)),this._measured_heartrate_qrs_counter>5&&(this.measured_heartrate=60/(this._measured_heartrate_time_counter/this._measured_heartrate_qrs_counter),this._measured_heartrate_qrs_counter=0,this._measured_heartrate_time_counter=0),this._qrs_time_counter>this.qrs_time&&(this._qrs_time_counter=0,this.ecg_signal=0,this._qrs_running=!1,this._qt_running=!0,this._ventricle_is_refractory=!0),this._qrs_vent_escape_time_counter>this.qrs_vent_escape_time&&(this._qrs_vent_escape_time_counter=0,this._qrs_vent_escape_running=!1,this._qt_running=!0,this._ventricle_is_refractory=!0),this._qt_time_counter>this.cqt_time&&(this._qt_time_counter=0,this._qt_running=!1,this._ventricle_is_refractory=!1),this._measured_heartrate_time_counter+=t,this._vent_escape_counter+=t,this._sa_node_counter+=t,this._pq_running&&(this._pq_time_counter+=t,this.buildDynamicPWave()),this._qrs_running&&(this._qrs_time_counter+=t,this.buidlDynamicQRSWave()),this._qrs_vent_escape_running&&(this._qrs_vent_escape_time_counter+=t,this.buidlDynamicQRSWaveVentricular()),this._qt_running&&(this._qt_time_counter+=t,this.buildDynamicTWave()),!1===this._pq_running&&!1===this._qrs_running&&!1===this._qt_running&&!1===this._qrs_vent_escape_running&&(this.ecg_signal=0),this._model.components.ecg["ecg_signal"]=this.ecg_signal,this._model.components.ecg["measured_heartrate"]=this.measured_heartrate}buildDynamicPWave(){let t=this._model.components.ecg["pq_time"],_=this._model.components.ecg["amp_p"],e=this._model.components.ecg["width_p"],i=this._model.components.ecg["skew_p"],s=_*Math.exp(-e*(Math.pow(this._pq_time_counter-t/i,2)/Math.pow(t,2))),r=s-this._prev_p_signal;this.ecg_signal+=r,this._prev_p_signal=s}buidlDynamicQRSWaveVentricular(){let t=0;this._qrs_vent_escape_time_counter<this.q_interval_vent&&(t=this.amp_q_vent*Math.exp(-this.width_q_vent*(Math.pow(this._qrs_vent_escape_time_counter-this.q_interval_vent/this.skew_q_vent,2)/Math.pow(this.q_interval_vent,2)))),this._qrs_vent_escape_time_counter>this.q_interval_vent&&this._qrs_vent_escape_time_counter<this.q_interval_vent+this.r_interval_vent&&(t=this.amp_r_vent*Math.exp(-this.width_r_vent*(Math.pow(this._qrs_vent_escape_time_counter-this.q_interval_vent-this.r_interval_vent/this.skew_r_vent,2)/Math.pow(this.r_interval_vent,2)))),this._qrs_vent_escape_time_counter>this.q_interval_vent+this.r_interval_vent&&this._qrs_vent_escape_time_counter<this.q_interval_vent+this.r_interval_vent+this.s_interval_vent&&(t=this.amp_s_vent*Math.exp(-this.width_s_vent*(Math.pow(this._qrs_vent_escape_time_counter-this.q_interval_vent-this.r_interval_vent-this.s_interval_vent/this.skew_s_vent,2)/Math.pow(this.s_interval_vent,2))));let _=t-this._prev_qrs_signal;this.ecg_signal+=_,this._prev_qrs_signal=t}buidlDynamicQRSWave(){let t=0;this._qrs_time_counter<this.q_interval&&(t=this.amp_q*Math.exp(-this.width_q*(Math.pow(this._qrs_time_counter-this.q_interval/this.skew_q,2)/Math.pow(this.q_interval,2)))),this._qrs_time_counter>this.q_interval&&this._qrs_time_counter<this.q_interval+this.r_interval&&(t=this.amp_r*Math.exp(-this.width_r*(Math.pow(this._qrs_time_counter-this.q_interval-this.r_interval/this.skew_r,2)/Math.pow(this.r_interval,2)))),this._qrs_time_counter>this.q_interval+this.r_interval&&this._qrs_time_counter<this.q_interval+this.r_interval+this.s_interval&&(t=this.amp_s*Math.exp(-this.width_s*(Math.pow(this._qrs_time_counter-this.q_interval-this.r_interval-this.s_interval/this.skew_s,2)/Math.pow(this.s_interval,2))));let _=t-this._prev_qrs_signal;this.ecg_signal+=_,this._prev_qrs_signal=t}buildDynamicTWave(){let t=this.cqt_time,_=this._model.components.ecg["amp_t"],e=this._model.components.ecg["width_t"],i=this._model.components.ecg["skew_t"],s=_*Math.exp(-e*(Math.pow(this._qt_time_counter-t/i,2)/Math.pow(t,2))),r=s-this._prev_t_signal;this.ecg_signal+=r,this._prev_t_signal=s}}